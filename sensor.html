<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>DHT sendors</title>
    <style type="text/css">
        body {
            font-size: 60pt;
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #000000;
        }

        div {
            color: #80FF00;
            margin: 30px;
        }
        
        div.time {
            color: #FFFF00;
            font-weight: bold;
            font-size: 120pt;
        }
        
        div.coin {
            font-size: 90pt;
            font-weight: bold;
            color: #FFFFFF;
        }
    </style>
    <style type="text/css"></style>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
        crossorigin="anonymous"></script>
</head>

<body>
    <div class="xx" align="center">　</div>
    <div class="living_room" align="center">客廳：00°C, 00%</div>
    <div class="room1" align="center">臥室：00°C, 00%</div>
    <div class="room2" align="center">客房：00°C, 00%</div>
    <div class="room3" align="center">書房：00°C, 00%</div>
    <div class="balcony" align="center">陽台：00°C, 00%</div>
    <div class="pm25" align="center">PM2.5：00 ug/m3</div>
    <div class="pm10" align="center">PM10：00 ug/m3</div>
    <div class="time" align="center">00:00:00</div>
    <div class="coin" align="center">　</div>

    <script>
        var max = 20;
        var living_room_t = 0, living_room_h = 0;
        var room1_t = 0, room1_h = 0;
        var room2_t = 0, room2_h = 0;
        var room3_t = 0, room3_h = 0;
        var balcony_t = 0, balcony_h = 0;
        var plant_level = -1, plant_water_times = -1;
        var pm25 = 0, pm10 = 0;
        var green = "#80FF00";

        $("div.living_room").css("color", "white");
        $("div.room1").css("color", "white");
        $("div.room2").css("color", "white");
        $("div.room3").css("color", "white");
        $("div.balcony").css("color", "white");
        $("div.pm25").css("color", "white");
        $("div.pm10").css("color", "white");
        
        $.getJSON("https://api.thingspeak.com/channels/72313/feeds.json?results=" + String(max),
            function (data) {
                $.each(data, function (key, val) {
                    if (key == "feeds") {
                        for (var i = 0; i < max; i++) {
                            if (val[i].field1 && val[i].field2) {
                                living_room_t = parseInt(val[i].field1);
                                living_room_h = parseInt(val[i].field2);
                            } else if (val[i].field3 && val[i].field4) {
                                room1_t = parseInt(val[i].field3);
                                room1_h = parseInt(val[i].field4);
                            } else if (val[i].field5 && val[i].field6) {
                                room2_t = parseInt(val[i].field5);
                                room2_h = parseInt(val[i].field6);
                            } else if (val[i].field7 && val[i].field8) {
                                room3_t = parseInt(val[i].field7);
                                room3_h = parseInt(val[i].field8);
                            }
                        }

                        if (living_room_h == 0)
                            $("div.living_room").css("color", "white");
                        else if (living_room_h >= 80)
                            $("div.living_room").css("color", "red");
                        else if (living_room_h >= 70)
                            $("div.living_room").css("color", "orange");
                        else
                            $("div.living_room").css("color", green);

                        if (room1_h == 0)
                            $("div.room1").css("color", "white");
                        else if (room1_h >= 80)
                            $("div.room1").css("color", "red");
                        else if (room1_h >= 70)
                            $("div.room1").css("color", "orange");
                        else
                            $("div.room1").css("color", green);

                        if (room2_h == 0)
                            $("div.room2").css("color", "white");
                        else if (room2_h >= 80)
                            $("div.room2").css("color", "red");
                        else if (room2_h >= 70)
                            $("div.room2").css("color", "orange");
                        else
                            $("div.room2").css("color", green);

                        if (room3_h == 0)
                            $("div.room3").css("color", "white");
                        else if (room3_h >= 80)
                            $("div.room3").css("color", "red");
                        else if (room3_h >= 70)
                            $("div.room3").css("color", "orange");
                        else
                            $("div.room3").css("color", green);

                        $("div.living_room").html("客廳：" + living_room_t + "°C, " + living_room_h + "%");
                        $("div.room1").html("臥室：" + room1_t + "°C, " + room1_h + "%");
                        $("div.room2").html("客房：" + room2_t + "°C, " + room2_h + "%");
                        $("div.room3").html("書房：" + room3_t + "°C, " + room3_h + "%");
                    }
                });
            });

        $.getJSON("https://api.thingspeak.com/channels/565880/feeds.json?results=" + String(max),
        function (data) {
            var timestamp = 0;
            $.each(data, function (key, val) {
                if (key == "feeds") {
                    for (var i = 0; i < max; i++) {
                        if (val[i].field1 && val[i].field2) {
                            balcony_t = parseInt(val[i].field1);
                            balcony_h = parseInt(val[i].field2);
                            timestamp = Date.parse(val[i].created_at);
                        }
                    }

                    if (balcony_h == 0 || Date.now() - timestamp > 1800000) // 1800000 = 0.5 hour
                        return;
                    else if (balcony_h >= 80)
                        $("div.balcony").css("color", "red");
                    else if (balcony_h >= 70)
                        $("div.balcony").css("color", "orange");
                    else
                        $("div.balcony").css("color", green);

                    $("div.balcony").html("陽台：" + balcony_t + "°C, " + balcony_h + "%");
                }
            });
        });
        
        $.getJSON("https://api.thingspeak.com/channels/72839/feeds.json?results=" + String(max),
            function (data) {
                $.each(data, function (key, val) {
                    var timestamp = 0;

                    if (key == "feeds") {
                        for (var i = 0; i < max; i++) {
                            if (val[i].field2)
                                pm25 = parseInt(val[i].field2);

                            if (val[i].field3)
                                pm10 = parseInt(val[i].field3);

                            timestamp = Date.parse(val[i].created_at);
                        }

                        if (Date.now() - timestamp > 1800000) // 1800000 = 0.5 hour
                            return;

                        if (pm25 >= 40)
                            $("div.pm25").css("color", "red");
                        else if (pm25 >= 20)
                            $("div.pm25").css("color", "orange");
                        else
                            $("div.pm25").css("color", green);

                        if (pm10 >= 40)
                            $("div.pm10").css("color", "red");
                        else if (pm10 >= 20)
                            $("div.pm10").css("color", "orange");
                        else
                            $("div.pm10").css("color", green);

                        $("div.pm25").html("PM2.5：" + pm25 + " ug/m3");
                        $("div.pm10").html("PM10：" + pm10 + " ug/m3");
                    }
                });
            });
            
            /* Cryptocurrency */
            $.getJSON("https://api.coinmarketcap.com/v2/ticker/?convert=TWD&limit=20",
            function (data) {
                var price_btc = 0, price_eth = 0;
                var percentage_btc = 0, percentage_eth = 0;
                
                for (var key in data.data) {
                    var coin = data.data[key];
                    var percentage = coin.quotes.USD.percent_change_24h;
                    var price = parseInt(coin.quotes.USD.price);
                    var color = "red";

                    if (coin.name == "Bitcoin") {
                        price_btc = price;
                        percentage_btc = percentage;
                        break;
                    }
                }

                if (price_btc > 0) {
                    if (percentage_btc > 3)
                        $("div.coin").css("color", "red");
                    else if (percentage_btc < -3)
                        $("div.coin").css("color", green);

                    $('div.coin').html(price_btc.toString());
                }
            });

        function set_time() {
            var d = new Date();
            $("div.time").html(d.toLocaleTimeString("en-US", { hour12: false , hour: "2-digit", minute: "2-digit"}));
            setTimeout(function () { set_time(); }, 1000);
        }
        
        set_time();
        setTimeout(function () { window.location = window.location; }, 300000);
        
    </script>
</body>

</html>
